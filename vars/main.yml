---
# vars file for postfix

postfix_service: postfix

_postfix_daemon_directory:
  default: /usr/libexec/postfix
  Debian: /usr/lib/postfix/sbin
  Suse: /usr/lib/postfix/bin

postfix_daemon_directory: "{{ _postfix_daemon_directory[ansible_os_family] | default(_postfix_daemon_directory['default']) }}"

_postfix_alias_path:
  default: /etc/aliases
  Alpine: /etc/postfix/aliases

postfix_alias_path: "{{ _postfix_alias_path[ansible_os_family] | default(_postfix_alias_path['default']) }}"

postfix_recipient_access_path: /etc/postfix/recipient_access

postfix_sender_access_path: /etc/postfix/sender_access

_postfix_group:
  default: postdrop
  Suse: maildrop

postfix_group: "{{ _postfix_group[ansible_os_family] | default(_postfix_group['default']) }}"

_postfix_compatibility_level:
  default: 2
  jammy: 3.6
  noble: 3.6
  bookworm: 3.6

postfix_compatibility_level: "{{ _postfix_compatibility_level[ansible_distribution_release] | default(_postfix_compatibility_level['default']) }}"

# Resolved variables for main.cf configuration (replacing Jinja in tasks)
# These variables handle string/list conversion and conditional prefix building

# Check recipient access prefix
_postfix_smtpd_recipient_restrictions_check_recipient_access: "{{ (postfix_recipient_access is defined) | ternary('check_recipient_access hash:' ~ postfix_recipient_access_path ~ ',', '') }}"

# Check sender access prefix
_postfix_smtpd_sender_restrictions_check_sender_access: "{{ (postfix_sender_access is defined) | ternary('check_sender_access hash:' ~ postfix_sender_access_path ~ ',', '') }}"

# Convert mynetworks to comma-separated string
_postfix_mynetworks: "{{ postfix_mynetworks | join(', ') }}"

# Convert mydestination to comma-separated string, or "<None>" if undefined
_postfix_mydestination: "{{ (postfix_mydestination is defined) | ternary(postfix_mydestination | join(', '), '<None>') }}"

# Convert relay_domains to comma-separated string, or "<None>" if undefined
_postfix_relay_domains: "{{ (postfix_relay_domains is defined) | ternary(postfix_relay_domains | join(', '), '<None>') }}"

# Combine check_recipient_access prefix with smtpd_recipient_restrictions
_postfix_smtpd_recipient_restrictions: "{{ (postfix_smtpd_recipient_restrictions is defined) | ternary(((_postfix_smtpd_recipient_restrictions_check_recipient_access | trim) ~ ' ' ~ (postfix_smtpd_recipient_restrictions | join(', ')) | trim), '') }}"

# Combine check_sender_access prefix with smtpd_sender_restrictions
_postfix_smtpd_sender_restrictions: "{{ (postfix_smtpd_sender_restrictions is defined) | ternary(((_postfix_smtpd_sender_restrictions_check_sender_access | trim) ~ ' ' ~ (postfix_smtpd_sender_restrictions | join(', ')) | trim), '') }}"

# Convert virtual_mailbox_domains to comma-separated string, or "<None>" if undefined
_postfix_virtual_mailbox_domains: "{{ (postfix_virtual_mailbox_domains is defined) | ternary(postfix_virtual_mailbox_domains | join(', '), '<None>') }}"

# Convert virtual_alias_domains to comma-separated string, or "<None>" if undefined
_postfix_virtual_alias_domains: "{{ (postfix_virtual_alias_domains is defined) | ternary(postfix_virtual_alias_domains | join(', '), '<None>') }}"

# Directory paths for TLS certificates
_postfix_smtpd_tls_cert_file_dir: "{{ (postfix_smtpd_tls_cert_file is defined) | ternary(postfix_smtpd_tls_cert_file | dirname, '') }}"
_postfix_smtpd_tls_key_file_dir: "{{ (postfix_smtpd_tls_key_file is defined) | ternary(postfix_smtpd_tls_key_file | dirname, '') }}"
