---
# tasks file for postfix

- name: Import assert.yml
  ansible.builtin.import_tasks:
    file: assert.yml
  run_once: true
  delegate_to: localhost

- name: Pre-configure debian systems
  ansible.builtin.debconf:
    name: postfix
    question: postfix/main_mailer_type
    vtype: string
    value: "No configuration"
  when:
    - ansible_os_family == "Debian"

- name: Install postfix
  ansible.builtin.package:
    name: postfix
    state: present

- name: Install postfix-mysql
  ansible.builtin.package:
    name: postfix-mysql
    state: present
  when:
    - (postfix_virtual_mailbox_maps is defined and "'mysql' in postfix_virtual_mailbox_maps) or
      (postfix_virtual_mailbox_domains is defined and 'mysql' in postfix_virtual_mailbox_domains) or
      (postix_virtual_alias_maps is defined and 'mysql' in postix_virtual_alias_maps")

- name: Configure postfix (transport_maps)
  ansible.builtin.template:
    src: "{{ postfix_transport_maps_template }}"
    dest: /etc/postfix/transport
    mode: "0644"
  notify:
    - Validate configuration
    - Rebuild transport_maps database
  when:
    - postfix_transport_maps_template is defined

- name: Configure postfix (header_checks)
  ansible.builtin.template:
    src: "{{ postfix_header_checks_template }}"
    dest: /etc/postfix/header_checks
    mode: "0644"
  notify:
    - Validate configuration
    - Reload postfix
  when:
    - postfix_header_checks_template is defined

- name: "Setting values for main.cf (1/2)"
  ansible.builtin.set_fact:
    _postfix_smtpd_recipient_restrictions_check_recipient_access: |
      {% if postfix_recipient_access is defined %}
      check_recipient_access hash:{{ postfix_recipient_access_path }},
      {% endif %}
    _postfix_smtpd_sender_restrictions_check_sender_access: |
      {% if postfix_sender_access is defined %}
      check_sender_access hash:{{ postfix_sender_access_path }},
      {% endif %}
    _postfix_smtpd_client_restrictions_check_client_access: |
      {% if postfix_client_access is defined %}
      check_client_access hash:{{ postfix_client_access_path }},
      {% endif %}
    _postfix_smtpd_relay_restrictions_check_relay_access: |
      {% if postfix_relay_access is defined %}
      check_client_access hash:{{ postfix_relay_access_path }},
      {% endif %}
    _postfix_local_header_rewrite_clients_access: |
      {% if postfix_local_header_rewrite_clients_access is defined %}
      check_address_map hash:{{ postfix_local_header_rewrite_clients_access_path }},
      {% endif %}

- name: "Setting values for main.cf (2/2)"
  ansible.builtin.set_fact:
    _postfix_mynetworks: >-
      {% if postfix_mynetworks is string %}{{ postfix_mynetworks }}
      {% elif postfix_mynetworks is iterable and (postfix_mynetworks is not string and postfix_mynetworks is not mapping) %}
      {% for network in postfix_mynetworks %}{{ network }}{% if not loop.last %}, {% endif %}{% endfor %}
      {% endif %}
    _postfix_mydestination: >-
      {% if postfix_mydestination is defined %}
      {% if postfix_mydestination is string %}
      {{ postfix_mydestination }}
      {% elif postfix_mydestination is iterable and (postfix_mydestination is not string and postfix_mydestination is not mapping) %}
      {% for domain in postfix_mydestination %}{{ domain }}{% if not loop.last %}, {% endif %}{% endfor %}
      {% endif %}
      {% else %}
      <None>
      {% endif %}
    _postfix_relay_domains: >-
      {% if postfix_relay_domains is defined %}
      {% if postfix_relay_domains is string %}
      {{ postfix_relay_domains }}
      {% elif postfix_relay_domains is iterable and (postfix_relay_domains is not string and postfix_relay_domains is not mapping) %}
      {% for domain in postfix_relay_domains %}{{ domain }}{% if not loop.last %}, {% endif %}{% endfor %}
      {% endif %}
      {% else %}
      <None>
      {% endif %}
    _postfix_smtpd_recipient_restrictions: >-
      {% if postfix_smtpd_recipient_restrictions is defined %}
      {% if postfix_smtpd_recipient_restrictions is string %}
      {{ _postfix_smtpd_recipient_restrictions_check_recipient_access | trim }} {{ postfix_smtpd_recipient_restrictions }}
      {% elif postfix_smtpd_recipient_restrictions is iterable and (postfix_smtpd_recipient_restrictions is not string and postfix_smtpd_recipient_restrictions is not mapping) %}
      {{ _postfix_smtpd_recipient_restrictions_check_recipient_access | trim }} {% for domain in postfix_smtpd_recipient_restrictions %}{{ domain }}{% if not loop.last %}, {% endif %}{% endfor %}
      {% endif %}
      {% endif %}
    _postfix_smtpd_sender_restrictions: >-
      {% if postfix_smtpd_sender_restrictions is defined %}
      {% if postfix_smtpd_sender_restrictions is string %}
      {{ _postfix_smtpd_sender_restrictions_check_sender_access | trim }} {{ postfix_smtpd_sender_restrictions }}
      {% elif postfix_smtpd_sender_restrictions is iterable and (postfix_smtpd_sender_restrictions is not string and postfix_smtpd_sender_restrictions is not mapping) %}
      {{ _postfix_smtpd_sender_restrictions_check_sender_access | trim }} {% for domain in postfix_smtpd_sender_restrictions %}{{ domain }}{% if not loop.last %}, {% endif %}{% endfor %}
      {% endif %}
      {% endif %}
    _postfix_smtpd_client_restrictions: >-
      {% if postfix_smtpd_client_restrictions is defined %}
      {% if postfix_smtpd_client_restrictions is string %}
      {{ _postfix_smtpd_client_restrictions_check_client_access | trim }} {{ postfix_smtpd_client_restrictions }}
      {% elif postfix_smtpd_client_restrictions is iterable and (postfix_smtpd_client_restrictions is not string and postfix_smtpd_client_restrictions is not mapping) %}
      {{ _postfix_smtpd_client_restrictions_check_client_access | trim }} {% for client in postfix_smtpd_client_restrictions %}{{ client }}{% if not loop.last %}, {% endif %}{% endfor %}
      {% endif %}
      {% endif %}
    _postfix_smtpd_relay_restrictions: >-
      {% if postfix_smtpd_relay_restrictions is defined %}
      {% if postfix_smtpd_relay_restrictions is string %}
      {{ _postfix_smtpd_relay_restrictions_check_relay_access | trim }} {{ postfix_smtpd_relay_restrictions }}
      {% elif postfix_smtpd_relay_restrictions is iterable and (postfix_smtpd_relay_restrictions is not string and postfix_smtpd_relay_restrictions is not mapping) %}
      {{ _postfix_smtpd_relay_restrictions_check_relay_access | trim }} {% for relay in postfix_smtpd_relay_restrictions %}{{ relay }}{% if not loop.last %}, {% endif %}{% endfor %}
      {% endif %}
      {% endif %}
    _postfix_local_header_rewrite_clients: >-
      {% if postfix_local_header_rewrite_clients is defined %}
      {% if postfix_local_header_rewrite_clients is string %}
      {{ _postfix_local_header_rewrite_clients_access | trim }} {{ postfix_local_header_rewrite_clients }}
      {% elif postfix_local_header_rewrite_clients is iterable and (postfix_local_header_rewrite_clients is not string and postfix_local_header_rewrite_clients is not mapping) %}
      {{ _postfix_local_header_rewrite_clients_access | trim }} {% for client in postfix_local_header_rewrite_clients %}{{ client }}{% if not loop.last %}, {% endif %}{% endfor %}
      {% endif %}
      {% endif %}
    _postfix_virtual_mailbox_domains: >-
      {% if postfix_virtual_mailbox_domains is defined %}
      {% if postfix_virtual_mailbox_domains is string %}
      {{ postfix_virtual_mailbox_domains }}
      {% elif postfix_virtual_mailbox_domains is iterable and (postfix_virtual_mailbox_domains is not string and postfix_virtual_mailbox_domains is not mapping) %}
      {% for domain in postfix_virtual_mailbox_domains %}{{ domain }}{% if not loop.last %}, {% endif %}{% endfor %}
      {% endif %}
      {% else %}
      <None>
      {% endif %}
    _postfix_virtual_alias_domains: >-
      {% if postfix_virtual_alias_domains is defined %}
      {% if postfix_virtual_alias_domains is string %}
      {{ postfix_virtual_alias_domains }}
      {% elif postfix_virtual_alias_domains is iterable and (postfix_virtual_alias_domains is not string and postfix_virtual_alias_domains is not mapping) %}
      {% for domain in postfix_virtual_alias_domains %}{{ domain }}{% if not loop.last %}, {% endif %}{% endfor %}
      {% endif %}
      {% else %}
      <None>
      {% endif %}

- name: Configure postfix (main.cf)
  ansible.builtin.template:
    src: main.cf.j2
    dest: /etc/postfix/main.cf
    validate: postconf -d -c %s
    mode: "0644"
  notify:
    - Validate configuration
    - Restart postfix

- name: Configure postfix (master.cf)
  ansible.builtin.template:
    src: master.cf.j2
    dest: /etc/postfix/master.cf
    validate: postconf -d -c %s
    mode: "0644"
  notify:
    - Validate configuration
    - Restart postfix

- name: Creates cert/key directory
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: 0700
  loop:
    - "{{ postfix_smtpd_tls_cert_file | dirname }}"
    - "{{ postfix_smtpd_tls_key_file | dirname }}"
  when:
    - postfix_smtpd_tls_cert_file is defined
    - postfix_smtpd_tls_key_file is defined
    - postfix_smtpd_tls_cert_file_source is defined
    - postfix_smtpd_tls_key_file_source is defined

- name: Deploy Postfix TLS server certificate
  ansible.builtin.copy:
    src: "{{ postfix_smtpd_tls_cert_file_source }}"
    dest: "{{ postfix_smtpd_tls_cert_file }}"
    mode: "0600"
  notify:
    - Reload postfix
  when:
    - postfix_smtpd_tls_cert_file_source is defined

- name: Deploy Postfix TLS server key
  ansible.builtin.copy:
    src: "{{ postfix_smtpd_tls_key_file_source }}"
    dest: "{{ postfix_smtpd_tls_key_file }}"
    mode: "0600"
  notify:
    - Reload postfix
  when:
    - postfix_smtpd_tls_key_file_source is defined

- name: Flush handlers
  ansible.builtin.meta: flush_handlers

- name: Ensure alias database exists
  ansible.builtin.command:
    cmd: postalias "{{ postfix_alias_path }}"
    creates: "{{ postfix_alias_path }}.db"
  notify:
    - Rebuild alias database
    - Reload postfix

- name: Configure aliases
  ansible.builtin.copy:
    dest: "{{ postfix_alias_path }}"
    content: |
      {% for alias in postfix_aliases %}
      {{ alias.name }}: {{ alias.destination }}
      {% endfor %}
    mode: "0644"
  when:
    - postfix_aliases is defined
    - postfix_aliases | length > 0
  notify:
    - Validate configuration
    - Rebuild alias database
    - Reload postfix

- name: Configure sender_access
  ansible.builtin.copy:
    dest: "{{ postfix_sender_access_path }}"
    content: |
      {% for entry in postfix_sender_access %}
      {{ entry.domain }} {{ entry.action }}
      {% endfor %}
    mode: "0644"
  when:
    - postfix_sender_access is defined
    - postfix_sender_access | length > 0
  notify:
    - Validate configuration
    - Rebuild sender_access database
    - Reload postfix

- name: Configure recipient_access
  ansible.builtin.copy:
    dest: "{{ postfix_recipient_access_path }}"
    content: |
      {% for entry in postfix_recipient_access %}
      {{ entry.domain }} {{ entry.action }}
      {% endfor %}
    mode: "0644"
  when:
    - postfix_recipient_access is defined
    - postfix_recipient_access | length > 0
  notify:
    - Validate configuration
    - Rebuild recipient_access database
    - Reload postfix

- name: Configure client_access
  ansible.builtin.copy:
    dest: "{{ postfix_client_access_path }}"
    content: |
      {% for entry in postfix_client_access %}
      {{ entry.client }} {{ entry.action }}
      {% endfor %}
    mode: "0644"
  when:
    - postfix_client_access is defined
    - postfix_client_access | length > 0
  notify:
    - Validate configuration
    - Rebuild client_access database
    - Reload postfix

- name: Configure relay_access
  ansible.builtin.copy:
    dest: "{{ postfix_relay_access_path }}"
    content: |
      {% for entry in postfix_relay_access %}
      {{ entry.client }} {{ entry.action }}
      {% endfor %}
    mode: "0644"
  when:
    - postfix_relay_access is defined
    - postfix_relay_access | length > 0
  notify:
    - Validate configuration
    - Rebuild relay_access database
    - Reload postfix

- name: Configure local_header_rewrite_clients_access
  ansible.builtin.copy:
    dest: "{{ postfix_local_header_rewrite_clients_access_path }}"
    content: |
      {% for entry in postfix_local_header_rewrite_clients_access %}
      {{ entry.client }} {{ entry.action }}
      {% endfor %}
    mode: "0644"
  when:
    - postfix_local_header_rewrite_clients_access is defined
    - postfix_local_header_rewrite_clients_access | length > 0
  notify:
    - Validate configuration
    - Rebuild local_header_rewrite_clients_access database
    - Reload postfix

- name: Place sender_dependent_relayhost_map
  ansible.builtin.copy:
    content: "{{ postfix_sender_dependent_relayhost_map_content }}"
    dest: "{{ postfix_sender_dependent_relayhost_map }}"
    mode: "0600"
  when:
    - postfix_sender_dependent_relayhost_map is defined and postfix_sender_dependent_relayhost_map != ""
  notify:
    - Validate configuration
    - Rebuild sender_dependent_relayhost_map database
    - Reload postfix

- name: Place sender_canonical_map
  ansible.builtin.copy:
    content: "{{ postfix_sender_canonical_map_content }}"
    dest: "{{ postfix_sender_canonical_map }}"
    mode: "0600"
  when:
    - postfix_sender_canonical_map is defined and postfix_sender_canonical_map != ""
  notify:
    - Validate configuration
    - Rebuild sender_canonical_map database
    - Reload postfix

- name: Place sasl_password_map
  ansible.builtin.copy:
    content: "{{ postfix_smtp_sasl_password_map_content }}"
    dest: "{{ postfix_smtp_sasl_password_map }}"
    mode: "0600"
  when:
    - postfix_smtp_sasl_password_map is defined and postfix_smtp_sasl_password_map != ""
  notify:
    - Validate configuration
    - Rebuild sasl_password_map database
    - Reload postfix

- name: Flush handlers again
  ansible.builtin.meta: flush_handlers

- name: Start and enable postfix
  ansible.builtin.service:
    name: "{{ postfix_service }}"
    state: started
    enabled: true
  when: not ansible_check_mode
